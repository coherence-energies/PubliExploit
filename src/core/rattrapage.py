import os
import sys
import subprocess
from utils.database_utils import log_to_database
from datetime import datetime

def call_another_program(repertoire, mail, mail_password, subject, num_boucle, periode):
    """
    Appeler un autre programme et transmettre les données.

    :param repertoire (String): Chemin vers le répertoire contenant les données.
    :param mail (String): Adresse e-mail destinataire pour le mail de fin
    :param mail_password (String): Mot de passe associé à l'adresse e-mail.
    :param subject (String): Objet de l'e-mail.
    """
    # Définit le chemin du programme à exécuter
    program_path = "/home/ubuntu/CEpublicationEXPL/src/cli/data_processor_cli.py"
    # Prépare les arguments à passer au programme
    args = [repertoire, mail, mail_password, subject, num_boucle, periode]

    try:
        # Exécute le programme externe en passant les arguments
        subprocess.run(["python3", program_path, *args], check=True)
    except subprocess.CalledProcessError as e:
        # Gère les erreurs en cas de problème lors de l'exécution du programme
        log_to_database(num_boucle, periode, datetime.now(), "", f"Erreur lors de l'appel du programme externe : {e}", 2, "ERROR")


def main():
    # Vérifie que le nombre d'arguments fournis en ligne de commande est correct.
    if len(sys.argv) != 4:
        print("Utilisation : python3 script.py <repertoire> <mail> <mail_password>")  # Ajout des arguments manquants
        sys.exit(1)
        
    repertoire = sys.argv[1]
    mail = sys.argv[2]
    mail_password = sys.argv[3]
    
    # Vérifier si le répertoire existe
    if not os.path.isdir(repertoire):
        print(f"Le répertoire {repertoire} n'existe pas.")
        sys.exit(1)
        
    for folder in os.listdir(repertoire):
        folder_path = os.path.join(repertoire, folder)
        if os.path.isdir(folder_path):            
            rep = folder.split('_')
            num_boucle = rep[0]
            date_debut = rep[2]
            date_fin = rep[3]
            periode = f"{date_debut}_{date_fin}"
            subject = "Rattrapage : " + folder 
            
            # Appelle la fonction `call_another_program` en passant les arguments requis
            call_another_program(folder_path, mail, mail_password, subject, num_boucle, periode)
            
